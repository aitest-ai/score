<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scratch AI è©•æ¸¬ç³»çµ± (ç‹€æ…‹è¨˜æ†¶ç‰ˆ)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; }
        .eval-card {
            background: white; border-radius: 12px; padding: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border: 1px solid #e5e7eb;
            transition: all 0.3s ease; position: relative; overflow: hidden;
        }
        .eval-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); border-color: #6366f1; }
        .loading-pulse { animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        dialog[open] { animation: zoomIn 0.2s ease-out; }
        @keyframes zoomIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        dialog::backdrop { background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(2px); }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set, onValue, update, remove, query, limitToLast, orderByChild } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // ==========================================
        // ğŸ”´ Config (ä¿æŒæ‚¨çš„è¨­å®š)
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyDe9Ab7oAzWgooCB3QY69YTHyvLJpuCGGE",
            authDomain: "score-a97d2.firebaseapp.com",
            databaseURL: "https://score-a97d2-default-rtdb.firebaseio.com",
            projectId: "score-a97d2",
            storageBucket: "score-a97d2.firebasestorage.app",
            messagingSenderId: "948644087844",
            appId: "1:948644087844:web:c67cdeee7d066a706bb0b1",
            measurementId: "G-N42YQDS7K0"
        };
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzfDdv5mEgmfWPeltiv9wxUKE0dNjBrTOO7zQ2tENxIvfCtv14gGD9aisPRFePS4LV5-A/exec"; 

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const DIMENSIONS_CONFIG = {
            "GAME": [
                { id: "documentation", name: "èªªæ˜æ–‡ä»¶ (15%)", max: 15 },
                { id: "mechanism", name: "éŠæˆ²æ©Ÿåˆ¶ (10%)", max: 10 },
                { id: "fun", name: "è¶£å‘³æ€§ (20%)", max: 20 },
                { id: "interaction", name: "äº’å‹•æ€§ (20%)", max: 20 },
                { id: "creativity", name: "å‰µæ„ (20%)", max: 20 },
                { id: "completeness", name: "å®Œæ•´æ€§ (25%)", max: 25 }
            ],
            "ANIMATION": [
                { id: "documentation", name: "èªªæ˜æ–‡ä»¶/åŠ‡æƒ… (15%)", max: 15 },
                { id: "program_design", name: "ç¨‹å¼è¨­è¨ˆ (30%)", max: 30 },
                { id: "story_presentation", name: "æ•…äº‹å‘ˆç¾ (30%)", max: 30 },
                { id: "creativity", name: "å‰µæ„ (25%)", max: 25 }
            ]
        };

        window.currentDataMap = {}; 
        window.activeModalKey = null;
        
        // ğŸŒŸ æ ¸å¿ƒä¿®æ­£ï¼šè¨˜ä½ç•¶å‰åˆ†é ï¼Œé˜²æ­¢è·³è½‰
        window.currentTabId = 'summary'; 

        function normalizeData(data) {
            if (!data.ai_details) return data;
            const map = {
                "ç¨‹å¼èªªæ˜æ–‡ä»¶": "documentation", "èªªæ˜æ–‡ä»¶": "documentation", 
                "éŠæˆ²æ©Ÿåˆ¶è¨­è¨ˆ": "mechanism", "éŠæˆ²æ©Ÿåˆ¶": "mechanism", 
                "éŠæˆ²è¶£å‘³æ€§": "fun", "è¶£å‘³æ€§": "fun", 
                "äº’å‹•æ“ä½œæ€§": "interaction", "äº’å‹•æ€§": "interaction", 
                "ç¨ç‰¹å‰µæ„æ€§": "creativity", "å‰µæ„æ€§": "creativity", "å‰µæ„": "creativity", "å‰µæ„è¡¨ç¾": "creativity",
                "åŠŸèƒ½å®Œæ•´æ€§": "completeness", "å®Œæ•´æ€§": "completeness", 
                "åŠ‡æƒ…": "documentation", "narrative_plot": "documentation",
                "å ´æ™¯": "documentation", "scene_planning": "documentation",
                "ç¨‹å¼": "program_design", "ç¨‹å¼è¨­è¨ˆ": "program_design", 
                "å‘ˆç¾": "story_presentation", "æ•…äº‹å‘ˆç¾": "story_presentation"
            };

            data.ai_details.forEach(agent => {
                if (agent.dimensions) {
                    let newDims = {};
                    Object.keys(agent.dimensions).forEach(key => {
                        let val = agent.dimensions[key];
                        let cleanKey = map[key] || key;
                        if(typeof val === 'object') { val.score = parseFloat(val.score) || 0; } 
                        else { val = { score: parseFloat(val) || 0, comment: "" }; }
                        newDims[cleanKey] = val;
                    });
                    agent.dimensions = newDims;
                }
            });
            return data;
        }

        const setStatus = (state, msg) => {
            const div = document.getElementById('statusDiv');
            const txt = document.getElementById('statusText');
            if(state === 'idle') { div.classList.add('hidden'); return; }
            div.classList.remove('hidden');
            txt.innerText = msg;
            div.className = state === 'error' ? "mt-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-800 text-sm flex items-center gap-2" : "mt-4 p-3 bg-indigo-50 border border-indigo-200 rounded-lg text-indigo-800 text-sm flex items-center gap-2";
        };

        window.handleFileSelect = (e) => {
            if (e.target.files[0]) document.getElementById('fileNameDisplay').innerText = e.target.files[0].name;
        };

        window.startEvaluation = async () => {
            if (GAS_API_URL.includes("æ‚¨çš„_GAS")) return alert("è«‹å…ˆè¨­å®š GAS URLï¼");
            
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            const docText = document.getElementById('docTextInput').value.trim();
            const groupType = document.getElementById('groupType').value;

            if (!file) return alert("è«‹å…ˆé¸æ“‡ .sb3 æª”æ¡ˆ");
            
            if (!docText) {
                if(!confirm("âš ï¸ æ‚¨å°šæœªå¡«å¯«ã€ç¨‹å¼èªªæ˜æ–‡ä»¶ã€‘ã€‚\nç›¸é—œåˆ†æ•¸å°‡ç›´æ¥ç‚º 0 åˆ†ã€‚\n\nç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ")) return;
            }

            setStatus('loading', 'æ­£åœ¨è®€å–æª”æ¡ˆ...');
            const tempKey = "temp_" + Date.now();
            createLoadingCard(tempKey, file.name, groupType);

            try {
                const zip = new JSZip();
                const content = await zip.loadAsync(file);
                if (!content.files["project.json"]) throw new Error("ç„¡æ•ˆçš„ Scratch æª”æ¡ˆ");
                const projectJsonString = await content.files["project.json"].async("string");

                setStatus('loading', 'AI è©•åˆ†ä¸­ (ç´„ 30-40 ç§’)...');

                const response = await fetch(GAS_API_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        fileName: file.name,
                        groupType: groupType,
                        projectJson: projectJsonString,
                        docText: docText
                    })
                });
                
                const result = await response.json();
                
                if (result.status === "success") {
                    setStatus('done', 'è©•æ¸¬å®Œæˆï¼');
                    await set(push(ref(db, 'evaluations')), {
                        ...result,
                        fileName: file.name,
                        groupType: groupType,
                        docText: docText,
                        human_evaluations: {},
                        createdAt: Date.now()
                    });
                    removeCard(tempKey);
                    fileInput.value = "";
                    document.getElementById('fileNameDisplay').innerText = "é»æ“Šé¸æ“‡ .sb3 æª”æ¡ˆ";
                    document.getElementById('docTextInput').value = "";
                } else {
                    throw new Error(result.message);
                }
            } catch (e) {
                console.error(e);
                setStatus('error', e.message);
                removeCard(tempKey);
            }
        };

        onValue(query(ref(db, 'evaluations'), orderByChild('createdAt'), limitToLast(50)), (snapshot) => {
            if (snapshot.exists()) {
                const dataObj = snapshot.val();
                const dataList = Object.keys(dataObj).map(key => ({ key, ...dataObj[key] })).sort((a, b) => b.createdAt - a.createdAt);
                
                updateGallery(dataList);

                // å³æ™‚åˆ·æ–° Modal ä¸”ä¿æŒåœ¨ç•¶å‰åˆ†é 
                if (window.activeModalKey && dataObj[window.activeModalKey]) {
                    const latestData = normalizeData({ key: window.activeModalKey, ...dataObj[window.activeModalKey] });
                    window.currentDataMap[window.activeModalKey] = latestData;
                    refreshModalUI(latestData);
                }
            } else {
                document.getElementById('galleryGrid').innerHTML = "";
            }
        });

        function updateGallery(dataList) {
            const container = document.getElementById('galleryGrid');
            const newKeys = new Set(dataList.map(d => d.key));
            container.querySelectorAll('.real-card').forEach(card => { if (!newKeys.has(card.id)) card.remove(); });

            dataList.forEach(data => {
                if (document.getElementById(data.key)) return;
                try {
                    window.currentDataMap[data.key] = normalizeData(data);
                    const cardHTML = generateCardHTML(window.currentDataMap[data.key]);
                    const firstReal = container.querySelector('.real-card');
                    if (firstReal) firstReal.insertAdjacentHTML('beforebegin', cardHTML);
                    else {
                        const loading = container.querySelector('.loading-card');
                        if (loading) loading.insertAdjacentHTML('afterend', cardHTML);
                        else container.insertAdjacentHTML('afterbegin', cardHTML);
                    }
                } catch (err) { console.error(err); }
            });
        }

        // ğŸŒŸ ä¿®æ­£å¾Œçš„åˆ·æ–°é‚è¼¯ï¼šå„ªå…ˆä½¿ç”¨ window.currentTabId
        function refreshModalUI(data) {
            renderSidebar(data); // é€™æœƒé‡ç•«æŒ‰éˆ•ï¼Œå°è‡´ DOM ç‹€æ…‹ä¸Ÿå¤±
            
            let targetTab = window.currentTabId; // å¾è®Šæ•¸è®€å–ç‹€æ…‹

            // é˜²å‘†ï¼šå¦‚æœåŸæœ¬çœ‹çš„å°ˆå®¶è¢«åˆªé™¤äº†ï¼Œå°±è·³å› summary
            if (targetTab.startsWith('human-')) {
                const hId = targetTab.replace('human-', '');
                if (!data.human_evaluations || !data.human_evaluations[hId]) {
                    targetTab = 'summary';
                }
            }
            
            switchTab(targetTab); // é‡æ–°å•Ÿç”¨æŒ‰éˆ•æ¨£å¼ä¸¦æ¸²æŸ“å…§å®¹
        }

        window.deleteData = async (key, event) => {
            event.stopPropagation();
            if(!confirm("ç¢ºå®šåˆªé™¤æ­¤è©•æ¸¬ç´€éŒ„ï¼Ÿ")) return;
            await remove(ref(db, 'evaluations/' + key));
        };

        function generateCardHTML(data) {
            const gType = data.groupType || "GAME";
            const dimsConfig = DIMENSIONS_CONFIG[gType] || DIMENSIONS_CONFIG["GAME"];
            const safeName = data.fileName || "æœªå‘½å";
            const humanCount = data.human_evaluations ? Object.keys(data.human_evaluations).length : 0;

            let barsHTML = '<div class="mt-4 space-y-2 border-t border-gray-100 pt-3">';
            let aiStats = {}; let count = 0;
            if (data.ai_details) {
                data.ai_details.forEach(agent => {
                    if (agent.dimensions) {
                        count++;
                        Object.keys(agent.dimensions).forEach(k => {
                            if (!aiStats[k]) aiStats[k] = 0;
                            aiStats[k] += (parseFloat(agent.dimensions[k].score) || 0);
                        });
                    }
                });
            }
            const div = count > 0 ? count : 1;

            dimsConfig.forEach(dim => {
                const rawScore = aiStats[dim.id] || 0;
                const avgScore = rawScore / div;
                const pct = Math.min((avgScore / dim.max) * 100, 100);
                let colorClass = pct < 60 ? 'bg-red-500' : (pct < 80 ? 'bg-yellow-500' : 'bg-emerald-500');

                barsHTML += `
                    <div class="flex items-center text-xs">
                        <div class="w-24 font-medium text-gray-500 text-right mr-3 truncate">${dim.name}</div>
                        <div class="flex-1 bg-gray-100 rounded-full h-1.5 overflow-hidden">
                            <div class="${colorClass} h-full" style="width: ${pct}%"></div>
                        </div>
                        <div class="w-8 text-right font-mono text-gray-700 ml-1 font-bold">${avgScore.toFixed(0)}</div>
                    </div>
                `;
            });
            barsHTML += '</div>';

            return `
                <div id="${data.key}" class="real-card eval-card cursor-pointer group" onclick="openModal('${data.key}')">
                    <button onclick="deleteData('${data.key}', event)" class="absolute top-3 right-3 text-gray-300 hover:text-red-500 p-2 rounded-full hover:bg-red-50 transition z-10 opacity-0 group-hover:opacity-100">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                    <div class="flex justify-between items-start mb-2 pr-8">
                        <span class="bg-indigo-50 text-indigo-700 text-xs font-bold px-2 py-1 rounded border border-indigo-100">${gType}</span>
                        <span class="text-xs text-gray-400">${new Date(data.createdAt).toLocaleDateString()}</span>
                    </div>
                    <h3 class="font-bold text-gray-800 text-lg mb-1 truncate" title="${safeName}">${safeName}</h3>
                    <div class="flex justify-between items-end mb-2">
                        <div>
                            <span class="text-3xl font-bold text-indigo-600">${data.ai_average}</span>
                            <span class="text-xs text-gray-500">AI å¹³å‡</span>
                        </div>
                        <div class="text-xs text-gray-500 bg-gray-50 px-2 py-1 rounded"><i class="fas fa-users mr-1"></i>${humanCount} å°ˆå®¶</div>
                    </div>
                    ${barsHTML}
                </div>`;
        }

        function createLoadingCard(key, fileName, groupType) {
            const grid = document.getElementById('galleryGrid');
            const html = `
                <div id="${key}" class="loading-card eval-card border-indigo-200 bg-indigo-50/50">
                    <div class="flex justify-between mb-2"><span class="bg-gray-200 text-gray-500 text-xs font-bold px-2 py-1 rounded">${groupType}</span></div>
                    <h3 class="font-bold text-gray-400 text-lg truncate">${fileName}</h3>
                    <div class="mt-4 space-y-3"><div class="h-2 bg-gray-200 rounded w-3/4"></div><div class="h-2 bg-gray-200 rounded w-full"></div></div>
                    <div class="mt-4 text-center text-sm text-indigo-500 font-bold animate-pulse">AI è©•åˆ†ä¸­...</div>
                </div>`;
            grid.insertAdjacentHTML('afterbegin', html);
        }

        function removeCard(key) { const el = document.getElementById(key); if (el) el.remove(); }

        window.openModal = (key) => {
            window.activeModalKey = key;
            const data = window.currentDataMap[key];
            if(!data) return;
            document.getElementById('modalTitle').innerText = data.fileName;
            
            // é–‹å•Ÿæ™‚ï¼Œé è¨­åˆ° summaryï¼Œä¸¦æ›´æ–°ç‹€æ…‹
            window.currentTabId = 'summary';
            
            renderSidebar(data);
            switchTab('summary');
            document.getElementById('detailModal').showModal();
        };
        window.closeModal = () => document.getElementById('detailModal').close();

        function renderSidebar(data) {
            const nav = document.getElementById('modalNav');
            let html = `<div class="mb-3 px-2 text-xs font-bold text-gray-400 uppercase">AI Reports</div>`;
            html += `<button onclick="switchTab('summary')" id="tab-summary" class="w-full text-left px-3 py-2 rounded-lg text-sm font-bold text-gray-700 hover:bg-gray-100 mb-1">ğŸ“Š ç¶œåˆå ±å‘Š</button>`;
            data.ai_details.forEach((a,i) => html += `<button onclick="switchTab('ai-${i}')" id="tab-ai-${i}" class="w-full text-left px-3 py-2 rounded-lg text-sm text-gray-600 hover:bg-gray-100 mb-1 flex justify-between"><span>ğŸ¤– AI #${i+1}</span><span class="bg-gray-100 text-xs px-2 py-0.5 rounded">${a.total_score}</span></button>`);
            html += `<div class="mt-6 mb-3 px-2 flex justify-between items-center text-xs font-bold text-gray-400 uppercase"><span>Human Experts</span><button onclick="addExpert()" class="hover:text-indigo-600"><i class="fas fa-plus"></i></button></div>`;
            if(data.human_evaluations) Object.entries(data.human_evaluations).forEach(([id,ex]) => html += `<button onclick="switchTab('human-${id}')" id="tab-human-${id}" class="w-full text-left px-3 py-2 rounded-lg text-sm text-gray-600 hover:bg-gray-100 mb-1 flex justify-between"><span>ğŸ‘¤ ${ex.name}</span><span class="bg-emerald-50 text-emerald-700 text-xs px-2 py-0.5 rounded font-bold">${ex.total_score}</span></button>`);
            nav.innerHTML = html;
        }

        // ğŸŒŸ ä¿®æ­£å¾Œçš„åˆ‡æ›é‚è¼¯ï¼šåŒæ™‚æ›´æ–° UI å’Œ ç‹€æ…‹è®Šæ•¸
        window.switchTab = (id) => {
            window.currentTabId = id; // 1. å„²å­˜ç‹€æ…‹

            document.querySelectorAll('#modalNav button').forEach(b => b.classList.remove('bg-indigo-50', 'text-indigo-700'));
            document.getElementById('tab-' + id)?.classList.add('bg-indigo-50', 'text-indigo-700');
            const content = document.getElementById('modalContent');
            const data = window.currentDataMap[window.activeModalKey];
            
            if (id === 'summary') renderSummary(data, content);
            else if (id.startsWith('ai-')) renderDetail(data.ai_details[id.split('-')[1]], content, data.groupType);
            else if (id.startsWith('human-')) renderHumanEditor(id.split('-')[1], data.human_evaluations[id.split('-')[1]], data.groupType, content);
        };

        function renderSummary(data, container) {
            let hTotal=0, hCount=0; if(data.human_evaluations) Object.values(data.human_evaluations).forEach(h=>{hTotal+=h.total_score; hCount++});
            const hAvg = hCount>0 ? (hTotal/hCount).toFixed(1) : "--";
            let diffMsg = hCount>0 ? (Math.abs(data.ai_average-hAvg)<5 ? "æ¥µé«˜" : "ä½") : "ç„¡è³‡æ–™";
            
            container.innerHTML = `
                <div class="p-8">
                    <div class="bg-amber-50 border border-amber-200 p-4 rounded-xl mb-6 text-sm text-amber-800">
                        <strong>ğŸ“œ èªªæ˜æ–‡ä»¶å…§å®¹ï¼š</strong><br>${data.docText || "ï¼ˆæœªæä¾›ï¼‰"}
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-8">
                        <div class="bg-indigo-50 p-5 rounded-2xl text-center"><div class="text-sm text-gray-500">AI å¹³å‡</div><div class="text-4xl font-bold text-indigo-600">${data.ai_average}</div></div>
                        <div class="bg-emerald-50 p-5 rounded-2xl text-center"><div class="text-sm text-gray-500">å°ˆå®¶å¹³å‡</div><div class="text-4xl font-bold text-emerald-600">${hAvg}</div><div class="text-xs text-emerald-600">ä¸€è‡´æ€§: ${diffMsg}</div></div>
                    </div>
                    <div class="space-y-4">${data.ai_details.map((a,i)=>`<div class="bg-white border p-4 rounded-xl"><div class="flex justify-between mb-2"><span class="font-bold text-indigo-900">AI #${i+1}</span><span class="bg-gray-100 px-2 rounded text-xs text-gray-500">${a.total_score}åˆ†</span></div><p class="text-sm text-gray-600">${a.overall_feedback}</p></div>`).join('')}</div>
                </div>`;
        }

        function renderDetail(review, container, gType) {
            const dims = DIMENSIONS_CONFIG[gType] || [];
            let html = `<div class="p-8"><div class="flex justify-between mb-6"><h2 class="text-xl font-bold">AI è©³ç´°è©•åˆ†</h2><div class="text-2xl font-bold text-indigo-600">${review.total_score}åˆ†</div></div><p class="bg-slate-50 p-4 rounded-lg mb-6 text-sm">${review.overall_feedback}</p>`;
            dims.forEach(d => {
                const v = review.dimensions?.[d.id] || {score:0, comment:"ç„¡"};
                html += `<div class="mb-4"><div class="flex justify-between text-sm font-bold mb-1"><span>${d.name}</span><span>${v.score}/${d.max}</span></div><div class="h-2 bg-gray-100 rounded-full mb-2"><div class="h-full bg-indigo-500 rounded-full" style="width:${(v.score/d.max)*100}%"></div></div><p class="text-xs text-gray-500">${v.comment}</p></div>`;
            });
            container.innerHTML = html + "</div>";
        }

        function renderHumanEditor(eid, ex, gType, container) {
            const dims = DIMENSIONS_CONFIG[gType] || [];
            let html = `
                <div class="p-8 bg-slate-50 min-h-full">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-slate-800">${ex.name}</h2>
                        <div class="flex items-center gap-4">
                            <div class="text-2xl font-bold text-emerald-600">${ex.total_score}åˆ†</div>
                            <button onclick="deleteExpert('${eid}')" class="text-xs bg-red-100 text-red-600 px-3 py-1.5 rounded hover:bg-red-200 transition"><i class="fas fa-trash-alt mr-1"></i>åˆªé™¤æ­¤å°ˆå®¶</button>
                        </div>
                    </div>
                    <textarea onchange="updComment('${eid}',this.value)" class="w-full p-4 border rounded-xl mb-6 h-24 text-sm" placeholder="ç¸½è©•...">${ex.comment||""}</textarea>`;
            
            dims.forEach(d => {
                const v = ex.dimensions?.[d.id] || {score:0, comment:""};
                html += `<div class="bg-white p-4 rounded-xl border mb-3 shadow-sm"><div class="flex justify-between mb-2"><label class="font-bold text-sm">${d.name}</label><span class="text-xs text-gray-400">æ»¿åˆ† ${d.max}</span></div><div class="flex gap-3"><input type="number" max="${d.max}" value="${v.score}" onchange="updDim('${eid}','${d.id}','score',this.value)" class="w-20 p-2 border rounded text-center font-bold text-emerald-600"><input type="text" value="${v.comment}" onchange="updDim('${eid}','${d.id}','comment',this.value)" class="flex-1 p-2 border rounded text-sm" placeholder="è©•èª"></div></div>`;
            });
            container.innerHTML = html + "</div>";
        }

        window.deleteExpert = async (expertId) => {
            if(!confirm("ç¢ºå®šè¦åˆªé™¤é€™ä½å°ˆå®¶çš„è©•åˆ†å—ï¼Ÿ")) return;
            const key = window.activeModalKey;
            await remove(ref(db, `evaluations/${key}/human_evaluations/${expertId}`));
        };

        window.addExpert = async () => {
            const name = prompt("è«‹è¼¸å…¥å°ˆå®¶å§“åï¼š"); if(!name) return;
            const key = window.activeModalKey;
            const id = "exp_" + Date.now();
            const gType = window.currentDataMap[key].groupType || "GAME";
            let dims = {}; DIMENSIONS_CONFIG[gType].forEach(d => dims[d.id] = {score:0, comment:""});
            
            // ğŸŒŸ è¨­å®šç‹€æ…‹ï¼Œç­‰ä¸‹ Firebase å›ä¾†æ™‚æœƒè‡ªå‹•åˆ‡æ›åˆ°é€™é 
            window.currentTabId = `human-${id}`;
            
            await update(ref(db, `evaluations/${key}/human_evaluations/${id}`), { name, total_score: 0, dimensions: dims });
        };

        window.updDim = async (eid, dim, f, v) => {
            let val = f==='score' ? parseFloat(v)||0 : v;
            await update(ref(db, `evaluations/${window.activeModalKey}/human_evaluations/${eid}/dimensions/${dim}`), {[f]:val});
            if(f==='score') setTimeout(async()=>{
                const d = window.currentDataMap[window.activeModalKey].human_evaluations[eid];
                let t=0; Object.values(d.dimensions).forEach(x=>t+=(parseFloat(x.score)||0));
                await update(ref(db, `evaluations/${window.activeModalKey}/human_evaluations/${eid}`), {total_score:t});
            }, 200);
        };
        window.updComment = async(eid, v) => update(ref(db, `evaluations/${window.activeModalKey}/human_evaluations/${eid}`), {comment:v});
        window.switchTab = switchTab; 
    </script>
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden">
    <nav class="bg-white border-b border-gray-200 shadow-sm shrink-0 z-20"><div class="max-w-7xl mx-auto px-6 h-16 flex items-center gap-3"><div class="bg-indigo-600 text-white p-2 rounded-lg"><i class="fas fa-robot text-lg"></i></div><h1 class="font-bold text-xl">Scratch AI <span class="text-indigo-600">Judge Pro</span></h1></div></nav>
    <div class="flex flex-1 overflow-hidden max-w-7xl mx-auto w-full">
        <aside class="w-80 bg-white border-r border-gray-200 p-6 flex flex-col gap-6 overflow-y-auto z-10 shadow-lg">
            <div class="space-y-4">
                <label class="block group cursor-pointer border-2 border-dashed border-indigo-200 bg-indigo-50/50 rounded-2xl p-8 text-center hover:bg-indigo-50 transition"><input type="file" id="fileInput" accept=".sb3" class="hidden" onchange="handleFileSelect(event)"><i id="uploadIcon" class="fas fa-cloud-upload-alt text-4xl text-indigo-400 mb-3 group-hover:scale-110 transition"></i><p class="text-sm font-bold text-indigo-900 mb-1">ä¸Šå‚³ .sb3 æª”æ¡ˆ</p><p class="text-xs text-indigo-400" id="fileNameDisplay">é»æ“Šé¸æ“‡æª”æ¡ˆ</p></label>
                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-2">è©•æ¸¬çµ„åˆ¥</label><select id="groupType" class="w-full border border-gray-200 text-gray-700 py-3 px-4 rounded-xl bg-white"><option value="GAME">ğŸ® éŠæˆ²çµ„</option><option value="ANIMATION">ğŸ¬ å‹•ç•«çµ„</option></select></div>
                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-2">ç¨‹å¼èªªæ˜æ–‡ä»¶å…§å®¹ (å¿…å¡«)</label><textarea id="docTextInput" class="w-full border border-gray-200 rounded-xl p-3 text-sm h-32 focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="è«‹åœ¨æ­¤è²¼ä¸Šèªªæ˜æ–‡ä»¶å…§å®¹... è‹¥æœªå¡«å¯«ï¼Œç›¸é—œåˆ†æ•¸å°‡ç‚º 0 åˆ†ã€‚"></textarea></div>
                <button onclick="startEvaluation()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3.5 px-4 rounded-xl shadow-lg transition active:scale-95 flex justify-center items-center gap-2"><i class="fas fa-bolt"></i> é–‹å§‹åš´æ ¼è©•æ¸¬</button>
            </div>
            <div id="statusDiv" class="hidden"><span id="statusText"></span></div>
        </aside>
        <main class="flex-1 bg-gray-50/50 p-8 overflow-y-auto"><div class="flex items-center justify-between mb-6"><h2 class="text-xl font-bold text-slate-800">è©•æ¸¬çµæœè—å»Š</h2></div><div id="galleryGrid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 pb-20"></div></main>
    </div>
    <dialog id="detailModal" class="bg-transparent p-0 w-full max-w-[95vw] h-[90vh] rounded-2xl shadow-2xl backdrop:bg-gray-900/60 outline-none m-auto"><div class="bg-white h-full flex flex-col rounded-2xl overflow-hidden"><div class="bg-white px-6 py-4 flex justify-between items-center border-b border-gray-100"><h2 class="text-lg font-bold text-gray-800" id="modalTitle">Title</h2><button onclick="closeModal()" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center"><i class="fas fa-times"></i></button></div><div class="flex flex-1 overflow-hidden"><div class="w-72 bg-white border-r border-gray-100 p-4 overflow-y-auto" id="modalNav"></div><div class="flex-1 overflow-y-auto bg-white relative" id="modalContent"></div></div></div></dialog>
</body>
</html>
